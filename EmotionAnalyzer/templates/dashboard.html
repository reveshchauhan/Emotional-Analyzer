{% extends 'layout.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="display-5">Emotion Dashboard</h1>
        <p class="lead">Visualizations and statistics of your emotion detection results</p>
    </div>
</div>

{% if emotions and counts %}
    <div class="row mb-5">
        <!-- Emotion Distribution Pie Chart -->
        <div class="col-md-6 mb-4">
            <div class="card emotion-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Emotion Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="emotionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Emotion Bar Chart -->
        <div class="col-md-6 mb-4">
            <div class="card emotion-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Emotion Frequency</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="emotionBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Detections -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card emotion-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i> Recent Detections</h5>
                </div>
                <div class="card-body">
                    {% if recent_results %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Image</th>
                                        <th>Source</th>
                                        <th>Dominant Emotion</th>
                                        <th>Confidence</th>
                                        <th>Faces</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for result in recent_results %}
                                        <tr>
                                            <td>{{ result.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                            <td>
                                                {% if result.filename %}
                                                    <img src="{{ url_for('uploaded_file', filename=result.filename) }}" 
                                                         alt="Detection result" 
                                                         class="img-thumbnail" 
                                                         style="max-height: 60px;">
                                                {% else %}
                                                    <span class="badge bg-secondary">No image</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if result.source_type == 'upload' %}
                                                    <span class="badge bg-primary">Upload</span>
                                                {% else %}
                                                    <span class="badge bg-success">Webcam</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge 
                                                    {% if result.dominant_emotion == 'angry' %}emotion-angry
                                                    {% elif result.dominant_emotion == 'disgust' %}emotion-disgust
                                                    {% elif result.dominant_emotion == 'fear' %}emotion-fear
                                                    {% elif result.dominant_emotion == 'happy' %}emotion-happy
                                                    {% elif result.dominant_emotion == 'sad' %}emotion-sad
                                                    {% elif result.dominant_emotion == 'surprise' %}emotion-surprise
                                                    {% else %}emotion-neutral{% endif %}">
                                                    {{ result.dominant_emotion|capitalize }}
                                                </span>
                                            </td>
                                            <td>{{ "%.2f"|format(result.confidence * 100) }}%</td>
                                            <td>{{ result.faces_detected }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center">
                            <a href="{{ url_for('history') }}" class="btn btn-primary">View All Detection History</a>
                        </div>
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            <h4 class="alert-heading">No detection data available</h4>
                            <p>You haven't analyzed any images or webcam captures yet. Go to the home page to start detecting emotions!</p>
                            <hr>
                            <p class="mb-0">
                                <a href="{{ url_for('index') }}" class="btn btn-primary">
                                    <i class="fas fa-home me-2"></i> Go to Home Page
                                </a>
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="row mb-5">
        <div class="col-md-4 mb-4">
            <div class="card emotion-card">
                <div class="card-body text-center">
                    <i class="fas fa-smile-beam text-warning" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Emotion Analysis Tips</h5>
                    <p class="card-text">For better results, ensure good lighting and face the camera directly.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card emotion-card">
                <div class="card-body text-center">
                    <i class="fas fa-camera text-info" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Image Quality</h5>
                    <p class="card-text">Upload clear images with visible facial features for more accurate detection.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card emotion-card">
                <div class="card-body text-center">
                    <i class="fas fa-users text-success" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Multiple Faces</h5>
                    <p class="card-text">The system can detect emotions in multiple faces in a single image or webcam frame.</p>
                </div>
            </div>
        </div>
    </div>
{% else %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading"><i class="fas fa-info-circle me-2"></i> No data available</h4>
                <p>There's no emotion detection data available yet. Start by analyzing some images or using your webcam.</p>
                <hr>
                <p class="mb-0">
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i> Go to Home Page
                    </a>
                </p>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Pass data from Python to JavaScript -->
<script>
    var emotions = '{{ emotions|safe }}';
    var counts = '{{ counts|safe }}';
</script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
{% endblock %}
